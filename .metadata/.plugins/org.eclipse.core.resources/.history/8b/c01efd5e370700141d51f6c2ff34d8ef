package kesaprojekti.remotelights;

import java.io.IOException;
import java.util.ArrayList;

import android.app.Activity;
import android.content.SharedPreferences;
import android.os.Bundle;
import android.preference.PreferenceManager;
import android.util.Log;
import android.view.View;
import android.widget.AdapterView;
import android.widget.AdapterView.OnItemClickListener;
import android.widget.ArrayAdapter;
import android.widget.ListView;
import android.widget.Toast;

public class ListActivity extends Activity implements OnItemClickListener {
	private static final String XML_FILE	= "settings.xml";
	
	private ArrayList<Integer>		activeAddr;	
	private ArrayList<String>		activeTargets;
	private ArrayAdapter<String>	adapter;

	@Override
	protected void onCreate(Bundle savedInstanceState) {
		super.onCreate(savedInstanceState);
		setContentView(R.layout.activity_list);
		
		ListView lv = (ListView)findViewById(R.id.listView1);
		
		SharedPreferences sharedPrefs		= PreferenceManager.getDefaultSharedPreferences(this);
        int status = sharedPrefs.getInt("status", 0);
		
        SelectLightsActivity sla	= new SelectLightsActivity();
        PullParserHandler parser 	= sla.getParser("zonename");
        
        
        
//		PullParserHandler	parser	= new PullParserHandler();
//    	
//    	try {
//			parser.parse(getAssets().open(XML_FILE), "zonename");
//		} catch (IOException e) {
//			e.printStackTrace();
//		}
    	
    	ArrayList<String>	allTargets		= new ArrayList<String>();
    	ArrayList<Integer> 	allAddr			= new ArrayList<Integer>();
    	
    	activeTargets	= new ArrayList<String>();
    	activeAddr		= new ArrayList<Integer>();
    	
    	
    	// get all target names
    	allTargets		= parser.getAllTargets();
    	//get all addresses
    	allAddr			= parser.getAllAddr();
    	
    	int targetCount = allTargets.size();
    	
    	
    	for (int i = 0; i < allTargets.size(); i++)	{
    		int mask = 1 << (targetCount - 1);
    		if ((status & mask) != 0)	{
    			activeTargets.add(allTargets.get(i));
    			activeAddr.add(allAddr.get(i));
    		}
    		targetCount--;
    	}

    	
    	
    	adapter = new ArrayAdapter<String>(this, R.layout.list_item, R.id.label, activeTargets);
		
		lv.setAdapter(adapter);
		
		lv.setOnItemClickListener(this);
    	
	}

	@Override
	public void onItemClick(AdapterView<?> parent, View view, int position,
			long id) {
		String item = (String) parent.getItemAtPosition(position);
		int address = activeAddr.get(position);
    	Thread thread = new ConnectionHandler(address, this);
    	thread.start();
		
		Toast.makeText(getApplicationContext(), item + " has been switched off.", Toast.LENGTH_LONG).show();
		activeTargets.remove(position);
		activeAddr.remove(position);
		adapter.notifyDataSetChanged();
		
	}
}
